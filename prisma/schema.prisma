// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// SONA 프로젝트 데이터 모델 정의
// 은하(갤럭시) → 항성계 → 행성(궤도/사운드) 구조

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  username         String          @unique
  password         String
  about            String? // 자기소개
  image            String? // 프로필 이미지 URL
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt
  // 관계: 사용자가 소유한 갤럭시들
  galaxies         Galaxy[]
  // 관계: 사용자가 소유한 항성계들
  stellar_systems  StellarSystem[] @relation("SystemOwner")
  // 관계: 사용자가 원작자인 항성계들
  authored_systems StellarSystem[] @relation("OriginalAuthor")
  // 관계: 사용자가 생성한(만든) 항성계들
  created_systems  StellarSystem[] @relation("SystemCreator")
  // 관계: 좋아요한 항성계들
  likes            Like[]
  // 관계: 팔로우 (팔로워)
  followers        Follow[]        @relation("UserFollowers")
  // 관계: 팔로우 (팔로잉)
  following        Follow[]        @relation("UserFollowing")
  // 관계: 받은 알림들
  notifications    Notification[]

  @@map("users")
}

// 내부 클론만 지원: 생성 방식은 수동(MANUAL) 또는 클론(CLONE)
enum CreationMethod {
  MANUAL
  CLONE
}

model Galaxy {
  id         String   @id @default(cuid())
  name       String
  owner_id   String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // 관계: 갤럭시 소유자 (1 User : N Galaxy)
  // - Galaxy.owner_id -> User.id
  // - 갤럭시가 삭제되면 해당 갤럭시 레코드만 삭제(Cascade는 Galaxy->User가 아니라 FK 소유측에만 의미)
  owner User @relation(fields: [owner_id], references: [id], onDelete: Cascade)

  // 관계: 이 갤럭시에 속한 항성계들 (1 Galaxy : N StellarSystem)
  // - StellarSystem.galaxy_id -> Galaxy.id
  stellar_systems StellarSystem[]

  @@index([owner_id]) // 소유자 기준 갤럭시 조회 최적화
  @@map("galaxies")
}

model StellarSystem {
  id                 String  @id @default(cuid())
  galaxy_id          String
  owner_id           String // 현재 소유자 (변경 가능)
  created_by_id      String // 최초 생성 실행자 (불변 권장)
  original_author_id String? // 원작자 (클론 시 원본의 원작자/없으면 원본 생성자)
  source_system_id   String? // 원본 시스템 (CLONE일 때 부모, MANUAL일 땐 null)

  title String

  created_via CreationMethod @default(MANUAL) // MANUAL | CLONE
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt

  // ───────────────────────────── 관계 설명 ─────────────────────────────
  // (A) 시스템이 속한 갤럭시 (N:1)
  // - FK: galaxy_id -> galaxies.id
  // - 갤럭시 삭제 시 해당 시스템들도 함께 삭제(onDelete: Cascade)
  galaxy Galaxy @relation(fields: [galaxy_id], references: [id], onDelete: Cascade)

  // (B) 현재 소유자 (N:1, User와 다중 관계이므로 name으로 구분)
  // - FK: owner_id -> users.id
  owner User @relation(fields: [owner_id], references: [id], onDelete: Cascade, name: "SystemOwner")

  // (C) 최초 생성자 (N:1)
  // - FK: created_by_id -> users.id
  created_by User @relation(fields: [created_by_id], references: [id], onDelete: Cascade, name: "SystemCreator")

  // (D) 원작자(선택) (N:1)
  // - FK: original_author_id -> users.id
  // - 클론 시: 원본의 original_author_id가 있으면 승계, 없으면 원본의 created_by_id 사용
  original_author User? @relation(fields: [original_author_id], references: [id], name: "OriginalAuthor")

  // (E) 클론 계보 (Self-Reference)
  // - 부모(원본) 시스템: source_system (N:1)
  // - 자식(복제된) 시스템들: cloned_systems (1:N)
  source_system  StellarSystem?  @relation(fields: [source_system_id], references: [id], name: "SourceSystem")
  cloned_systems StellarSystem[] @relation("SourceSystem")

  // (F) 이 시스템에 속한 플래닛들 (1:N)
  // - Planet.system_id -> StellarSystem.id
  planets Planet[]

  // (G) 좋아요(선택) (1:N)
  // - Like.system_id -> StellarSystem.id
  // - Like 모델은 별도 정의 필요(복합 유니크로 user당 1번 제한)
  likes Like[]
  // 갤럭시 내 시스템명 중복 방지하고 싶으면 주석 해제:
  // @@unique([galaxy_id, title])

  @@index([galaxy_id])
  @@index([owner_id])
  @@index([created_by_id])
  @@index([source_system_id])
  @@map("stellar_systems")
}

model Planet {
  id        String @id @default(cuid())
  system_id String // 소속 시스템 (N:1)
  name      String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // 관계: 소속 시스템 (N:1)
  // - FK: system_id -> stellar_systems.id
  // - 시스템 삭제 시 플래닛도 함께 삭제
  system StellarSystem @relation(fields: [system_id], references: [id], onDelete: Cascade)

  // 관계: 1:1 패턴 (Planet 기준 0..1)
  // - Pattern.planet_id가 UNIQUE이므로 행성당 패턴은 최대 1개
  pattern Pattern?

  @@index([system_id])
  @@map("planets")
}

model Pattern {
  id        String @id @default(cuid())
  planet_id String @unique // 행성과 1:1 관계 (UNIQUE로 강제)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // 관계: 소속 행성 (1:1의 반대편)
  // - FK: planet_id -> planets.id
  // - 행성 삭제 시 패턴도 함께 삭제
  planet Planet @relation(fields: [planet_id], references: [id], onDelete: Cascade)

  @@map("patterns")
}

model Like {
  id         String   @id @default(cuid())
  user_id    String
  system_id  String
  created_at DateTime @default(now())

  // 관계: 좋아요한 사용자
  user   User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  // 관계: 좋아요받은 시스템
  system StellarSystem @relation(fields: [system_id], references: [id], onDelete: Cascade)

  // 유니크 제약: 한 사용자는 한 시스템에 하나의 좋아요만
  @@unique([user_id, system_id])
  @@index([user_id])
  @@index([system_id])
  @@map("likes")
}

model Option {
  id         String   @id @default(cuid())
  code       String   @unique // 'week' | 'month' | 'year' | 'random'
  label      String // '이번 주' 등 UI용
  sort       Int      @default(0) // 정렬
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("options")
}

model Follow {
  follower_id String
  followee_id String
  created_at  DateTime @default(now())

  // 관계: 팔로워
  follower User @relation(fields: [follower_id], references: [id], onDelete: Cascade, name: "UserFollowers")
  // 관계: 팔로잉
  followee User @relation(fields: [followee_id], references: [id], onDelete: Cascade, name: "UserFollowing")

  // 복합 Primary Key
  @@id([follower_id, followee_id])
  @@index([followee_id], map: "idx_follow_followee") //조회 성능을 위해 인덱스를 추가
  @@index([follower_id], map: "idx_follow_follower")
  @@map("follows")
}

model Notification {
  id          String   @id @default(cuid())
  user_id     String // 알림을 받을 사용자
  type        String // 알림 타입 ('like', 'follow', 'clone', etc.)
  entity_type String // 엔티티 타입 ('stellar_system', 'user', etc.)
  entity_id   String // 엔티티 ID
  actor_id    String? // 알림을 발생시킨 사용자 ID
  message     String? // 알림 메시지
  read        Boolean  @default(false)
  created_at  DateTime @default(now())

  // 관계: 알림을 받는 사용자
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}
